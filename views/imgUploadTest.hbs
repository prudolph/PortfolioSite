
{{error_messages}}

<script>
function uploadFile(file, signedRequest, url){
  const xhr = new XMLHttpRequest();

  console.log("Uploade File : ", signedRequest);
  xhr.open('PUT', signedRequest);
  xhr.onreadystatechange = () => {
    if(xhr.readyState === 4){
      if(xhr.status === 200){
        document.getElementById('preview').src = url;
        document.getElementById('avatar-url').value = url;
      }
      else{
        alert('Could not upload file.');
      }
    }
  };
  xhr.send(file);
}

function getSignedRequest(file){
  const xhr = new XMLHttpRequest();
  xhr.open('GET', `/admin/sign-s3?file-name=${file.name}&file-type=${file.type}`);
  xhr.onreadystatechange = () => {
    if(xhr.readyState === 4){
      if(xhr.status === 200){
        const response = JSON.parse(xhr.responseText);
        uploadFile(file, response.signedRequest, response.url);
      }
      else{
        alert('Could not get signed URL.');
      }
    }
  };
  xhr.send();
}


  function handleFileSelect(event){
       console.log("File Selected");

       var tgt = event.target || window.event.srcElement,
       files = tgt.files;
      const file = files[0];
       console.log("Files ",files);
       // FileReader support
         if (FileReader && files && files.length) {
             var reader = new FileReader();
             reader.onload = function () {

                   $('#preview').attr('src', reader.result);
             }
             reader.readAsDataURL(file);


         }

         // Not supported
         else {
             // fallback -- perhaps submit the input to an iframe and temporarily store
             // them on the server until the user's session ends.
             console.log("Filereader not supported");
         }

/*
       const files = document.getElementById('file-input').files;

       console.log("file", file);
       $('#preview').attr("src",file.name);
       var reader = new FileReader();
              reader.onload = function (e) {
                 $('#img').attr('src', file);
              }
             reader.readAsDataURL(file);
       if(file == null){
         return alert('No file selected.');
       }
*/

       getSignedRequest(file);


 };
</script>


<div class="upload">
  <form method="POST" action="/save-details">
    <input type="file" id="file-input" onchange="handleFileSelect(this)" >
    <img id="preview"   style="width:100px; height:100px;">

    <p id="status">Please select a file</p>
    <input type="submit" value="add">
  </form>

</div>
